(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{367:function(t,e,a){t.exports=a.p+"assets/img/create-prvalidation-pr.c38ded18.png"},368:function(t,e,a){t.exports=a.p+"assets/img/open-prvalidation-pr.0d2fb668.png"},369:function(t,e,a){t.exports=a.p+"assets/img/apply-label.a0cc15ab.png"},370:function(t,e,a){t.exports=a.p+"assets/img/apply-validate-label.9ce173b1.png"},371:function(t,e,a){t.exports=a.p+"assets/img/validate-pr-build.7f474ba9.png"},372:function(t,e,a){t.exports=a.p+"assets/img/what-if-bot.b61db2eb.png"},373:function(t,e,a){t.exports=a.p+"assets/img/apply-stage-label.9f26ba32.png"},374:function(t,e,a){t.exports=a.p+"assets/img/stage-build.2a367f5c.png"},375:function(t,e,a){t.exports=a.p+"assets/img/stage-bot.c9b773de.png"},376:function(t,e,a){t.exports=a.p+"assets/img/apply-destroy-label.3614b558.png"},390:function(t,e,a){"use strict";a.r(e);var s=a(45),n=Object(s.a)({},(function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"challenge-05-create-a-pull-request-validation-workflow"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#challenge-05-create-a-pull-request-validation-workflow"}},[t._v("#")]),t._v(" Challenge_05 Create a Pull Request validation workflow")]),t._v(" "),s("p",[t._v("In this challenge we will create a GitHub workflow that is used to validate a Pull Request.\nIf you work on a new feature or if you make changes to your production system, a best practice is to create a branch from your main branch and do all the work in the newly created branch before changes are merged back to the main branch. This strategy keeps your main branch clean and build breaks can be avoided. When you have finished your work you create a Pull Request to collaborate with other team members to review and discuss about the changes.")]),t._v(" "),s("h2",{attrs:{id:"the-scenario"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-scenario"}},[t._v("#")]),t._v(" The scenario")]),t._v(" "),s("p",[t._v("Let's say we want to roll out an Azure Storage account in a Resource Group using an ARM template. In order to ensure that we do not destroy anything in the production system, it would make sense to get feedback within the pull request which changes the ARM template would cause. Of course, we do not want to run this test against the production system. But since we have mapped the current state of the production system in the main branch, we can use the sources from the main branch to build a temporary environment. Once the temporary environment is created, we can run the test against that environment. To test the effect of an ARM template we use an ARM template deployment with the what-if option.")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("CHANGES")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("az deployment group what-if -n demo01 -g rg-name --template-file path/to/template --parameters "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("param01")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("value01\n")])])]),s("p",[t._v("For better collaboration, it makes sense to map this procedure in a GitHub workflow and visualize the result of the what-if deployment directly in the pull request. This allows the team to discuss the possible changes.")]),t._v(" "),s("p",[t._v("The GitHub Script action allows us to access GitHub resources like an issue and add a comment. You can find the documentation "),s("a",{attrs:{href:"https://github.com/actions/github-script",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),s("OutboundLink")],1),t._v(" on GitHub.")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" actions/github"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("script@v3\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("with")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("github-token")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" github.token "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n      github.issues.createComment({\n        issue_number: ${{ github.event.number }},\n        owner: context.repo.owner,\n        repo: context.repo.repo,\n        body: `your comment`\n        })")]),t._v("\n\n")])])]),s("h3",{attrs:{id:"the-flow-to-validate-an-arm-template-with-a-what-if-deployment-within-a-pull-request"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#the-flow-to-validate-an-arm-template-with-a-what-if-deployment-within-a-pull-request"}},[t._v("#")]),t._v(" The flow to validate an ARM template with a what-if deployment within a Pull Request")]),t._v(" "),s("p",[t._v("The following diagram illustrates the what-if deployment process:")]),t._v(" "),s("p",[s("img",{attrs:{src:"images/what-if-overview.png",alt:"what-if overview"}})]),t._v(" "),s("h3",{attrs:{id:"deploy-to-a-staging-environment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#deploy-to-a-staging-environment"}},[t._v("#")]),t._v(" Deploy to a staging environment")]),t._v(" "),s("p",[t._v("At this point we can prepare an environment from the main branch and rollout our ARM template with the what-if option to see how the template would affect the environment.\nThis is a great way to already check what would happen. But this is not enough, because we also want to know how an environment looks like when we deploy the ARM template. That's why we extend our workflow to build a staging environment. This environment can then be tested, validated and it is a copy of the production system with the changes that the ARM template brings.\nAgain, the environment is first built from the main branch and then the ARM template is deployed from the branch. The GitHub script action is used to add a comment to the pull request describing the necessary information of the staging environment (e.g. name of the ResourceGroup).")]),t._v(" "),s("p",[s("img",{attrs:{src:"images/staging-workfow.png",alt:"staging-workflow"}})]),t._v(" "),s("p",[t._v("After the environment is provided we can take all measures to ensure the quality.")]),t._v(" "),s("h3",{attrs:{id:"destroy-the-staging-environment"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#destroy-the-staging-environment"}},[t._v("#")]),t._v(" Destroy the staging environment")]),t._v(" "),s("p",[t._v("If the staging environment meets our quality requirements, we can delete this environment again and take over the pull request.\nDestroying the staging environment is easy. We just need to delete the ResourceGroup with a simple Azure CLI command:")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("az group delete -n rg-name -y\n")])])]),s("h3",{attrs:{id:"unique-names-for-temporary-environments"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#unique-names-for-temporary-environments"}},[t._v("#")]),t._v(" Unique names for temporary environments")]),t._v(" "),s("p",[t._v("When we create the name for our temporary environments, we need to make sure they are unique. Also, it would be useful to somehow associate the name with the name of the branch to which the pull request belongs. There is a GitHub action available which exposes short values of some GitHub environment variables inside a GitHub workflow.\nThe documentation of the GitHub Slug action can be found "),s("a",{attrs:{href:"https://github.com/rlespinasse/github-slug-action",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),s("OutboundLink")],1),t._v(".\nThe action injects the "),s("strong",[t._v("GITHUB_HEAD_REF_SLUG_URL")]),t._v(" environment variable. Git has a special reference, "),s("strong",[t._v("HEAD")]),t._v(". This is a symbolic reference which points to the tip of the current branch, rather than an actual commit. If we have a branch called "),s("strong",[t._v("my-branch")]),t._v(" the reference would look like this: "),s("strong",[t._v("refs/head/my-branch")]),t._v(".\nThe environment variable "),s("strong",[t._v("GITHUB_HEAD_REF_SLUG_URL")]),t._v(" contains a short value for "),s("strong",[t._v("HEAD")]),t._v(", which is at the end the name of the branch "),s("strong",[t._v("my-branch")]),t._v(". We can use this value as the name for the ResourceGroup, since this name is unique within our repository.\nThe following yaml snippet shows how to use the GitHub Slug action and how to assign the "),s("strong",[t._v("GITHUB_HEAD_REF_SLUG_URL")]),t._v(" environment variable to an environment variable "),s("strong",[t._v("ResourceGroupName")]),t._v(":")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("env")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ResourceGroupName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ResourceGroupLocation")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"westeurope"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("StorageAccountPrefix")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"sta"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy-from-main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Inject slug/short variables\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("uses")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rlespinasse/github"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("slug"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("action@v3.x\n\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Set ResourceGroupName from slug/short\n        "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("run")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(' echo "ResourceGroupName=$'),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" env.GITHUB_HEAD_REF_SLUG_URL "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v('rg" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" $GITHUB_ENV\n")])])]),s("p",[t._v("Of course, we also need to make sure that all Azure resources that need a unique name get one. If we look at the ARM template, we see that a prefix parameter must be passed. With this prefix and the unique ID of the resource group a unique name for the storage account is created:")]),t._v(" "),s("div",{staticClass:"language-JSON extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"parameters"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"storageAccountPrefix"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"type"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"string"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"metadata"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"description"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"prefix to use for the storage account\'s name"')]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"variables"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"storageAccountName"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"[concat(parameters('storageAccountPrefix'), take(uniqueString(resourceGroup().id), 4))]\"")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("p",[t._v("The ARM template can be found under the repository's root "),s("a",{attrs:{href:"./templates/challenge_05/storage.json"}},[t._v("/challenges/templates/challenge_05/storage.json")]),t._v(".")]),t._v(" "),s("h3",{attrs:{id:"apply-labels-to-your-pull-request-to-control-the-workflow"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#apply-labels-to-your-pull-request-to-control-the-workflow"}},[t._v("#")]),t._v(" Apply labels to your Pull Request to control the workflow")]),t._v(" "),s("p",[t._v("We now have the basis to either run a validation or build a staging environment and delete it again.\nBut how do we control whether a validation or the creation of a staging environment should be triggered?\nThe answer is GitHub labels.")]),t._v(" "),s("p",[t._v("A workflow needs a trigger to be executed. As we want the workflow to be triggered only  within a Pull Request and if a label is applied, we use the Pull Request trigger and the type "),s("strong",[t._v("labeled")]),t._v(" as follow:")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" PullRequest Validation\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("pull_request")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("types")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("labeled"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("By specifying this, the workflow will only be started if a pull request has been created and a label is applied.\nNext, it is necessary to check within the definition which label has been set. Let's assume we have the following labels:")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("validate")]),t._v(": runs the what-if deployment")]),t._v(" "),s("li",[s("strong",[t._v("stage")]),t._v(": deploys the changes to a staging environment")]),t._v(" "),s("li",[s("strong",[t._v("destroy")]),t._v(": destroys the staging environment")])]),t._v(" "),s("p",[t._v("Now we can check and decide which steps should be executed within the workflow based on the value of the label.")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("jobs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("deploy-from--main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n      (contains(github.event.pull_request.labels.*.name, 'validate') ||\n      contains(github.event.pull_request.labels.*.name, 'stage')) &&\n      !contains(github.event.pull_request.labels.*.name, 'destroy')")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("what-if-deployment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("needs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("from"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("main\n\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n      contains(github.event.pull_request.labels.*.name, 'validate') &&\n      !contains(github.event.pull_request.labels.*.name, 'stage') &&\n      !contains(github.event.pull_request.labels.*.name, 'destroy')")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage-deployment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("needs")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("from"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("main\n\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),s("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v("\n      contains(github.event.pull_request.labels.*.name, 'stage') &&\n      !contains(github.event.pull_request.labels.*.name, 'destroy')")]),t._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("destroy-stage-deployment")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("runs-on")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ubuntu"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("latest\n\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" contains(github.event.pull_request.labels."),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("*.name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" 'destroy')\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("steps")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n")])])]),s("h3",{attrs:{id:"inspect-the-workflow-definition"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#inspect-the-workflow-definition"}},[t._v("#")]),t._v(" Inspect the workflow definition")]),t._v(" "),s("p",[t._v("Don't worry, we don't want you to implement the workflow yourself now. The workflow is already there. Please take your time and have a close look at the definition before we see the workflow in action.\nThe workflow definition can be found in the repository's root directory under "),s("a",{attrs:{href:"../.github/workflows/pr-validation.yml"}},[t._v(".github/workflows/pr-validation.yml")]),t._v(".")]),t._v(" "),s("h2",{attrs:{id:"see-the-workflow-in-action"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#see-the-workflow-in-action"}},[t._v("#")]),t._v(" See the workflow in action")]),t._v(" "),s("p",[t._v("Now it's time to see the workflow for the described scenario in action.\nFirst we need to create a new branch and make some changes to the code.")]),t._v(" "),s("p",[t._v("Open a shell, navigate to the iac-basics-workshop folder, create a branch and check it out:")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" branch prvalidation\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" checkout prvalidation\n")])])]),s("p",[t._v("Rename the file "),s("a",{attrs:{href:"./templates/challenge_05/storage.json__rename_me"}},[t._v("/challenges/templates/challenge_05/storage.json__rename_me")]),t._v(" to "),s("strong",[t._v("storage.json")]),t._v(".")]),t._v(" "),s("p",[t._v("Add and commit the changes:")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"see the workflow in action"')]),t._v("\n")])])]),s("p",[t._v("Next, push the branch to the remote repository:")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push --set-upstream origin prvalidation\n")])])]),s("p",[t._v("Now the branch is available in your remote repository. Open a browser, navigate to your iac-basics-workshop repository and click the "),s("strong",[t._v("Pull Request")]),t._v(" tab.\nYou will see that GitHub informs you that your branch "),s("strong",[t._v("prvalidation")]),t._v(" had recent pushes and thta the branch is ready to integrate by creating a Pull Request:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(367),alt:"prvalidation-pullrequest"}})]),t._v(" "),s("p",[t._v("Click "),s("strong",[t._v("Compare & pull request")]),t._v(" to open a Pull Request for your changes. If you like, you can leave a title and a comment for your pull request.\nTake the time to see what information is already provided within the pull request.")]),t._v(" "),s("p",[s("img",{attrs:{src:a(368),alt:"open-prvalidation-pr"}})]),t._v(" "),s("p",[t._v("Click "),s("strong",[t._v("Create pull request")]),t._v(" to create your Pull Request.")]),t._v(" "),s("p",[t._v("After the Pull Request is created, we can trigger a what-if deployment. To trigger the deployment we need to apply the label "),s("strong",[t._v("validate")]),t._v(" to our Pull Request. In your open Pull Request, you can add a label in the right-hand side bar under "),s("strong",[t._v("Labels")]),t._v(":")]),t._v(" "),s("p",[s("img",{attrs:{src:a(369),alt:"apply-label"}})]),t._v(" "),s("p",[t._v("Add the label validate. If you use the label validate for the first time, you have to create it:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(370),alt:"apply-label-validate"}})]),t._v(" "),s("p",[t._v("After the label is applied it takes a few seconds until the workflow is triggered. Click on "),s("strong",[t._v("Details")]),t._v(" to see more information:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(371),alt:"validate-pr-build"}})]),t._v(" "),s("p",[t._v("When the what-if deployment has run, we see the result in the pull request, which is stored as a comment. Based on this comment, we can discuss the possible changes in the team:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(372),alt:"what-if-bot"}})]),t._v(" "),s("p",[t._v("As a next step, we can add the label stage to deploy the changes in a temporary staging environment. We can use this environment to check the changes live:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(373),alt:"apply-stage-label"}})]),t._v(" "),s("p",[t._v("After the label is applied it takes a few seconds until the workflow is triggered. Click on "),s("strong",[t._v("Details")]),t._v(" to see more information:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(374),alt:"stage-build"}})]),t._v(" "),s("p",[t._v("When the stage deployment has run, we see the result in the pull request, which is stored as a comment. The comment contains the name of the Resource Group where the staging environment is deployed:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(375),alt:"stage-bot"}})]),t._v(" "),s("p",[t._v("Navigate to your Azure subscription in the Azure portal and check if the resource group is there.")]),t._v(" "),s("p",[t._v("As mentioned in the comment, we can delete the staging environment when we add the label destroy. Again, it takes a few seconds until the workflow is started:")]),t._v(" "),s("p",[s("img",{attrs:{src:a(376),alt:"apply-destroy-label"}})]),t._v(" "),s("h2",{attrs:{id:"congratulations"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#congratulations"}},[t._v("#")]),t._v(" Congratulations")]),t._v(" "),s("p",[t._v("You have seen how you can use a pull request and a GitHub workflow in an advanced scenario.")])])}),[],!1,null,null,null);e.default=n.exports}}]);